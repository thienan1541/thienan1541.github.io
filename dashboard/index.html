<link rel="stylesheet" href="nav.css">
<!-- Bootstrap CSS -->
<link rel="stylesheet" href="../css/bootstrap.min.css">
<!-- jQuery -->
<script src="../js/jquery.min.js"></script>
<!-- Bootstrap JS -->
<script src="../js/bootstrap.min.js"></script>
<!-- Firebase JavaScript SDK -->
<script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="../js/firebaseDefaultConfig.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<div class="vertical-nav bg-white" id="sidebar">
    <div class="py-4 px-3 mb-4 bg-light">
        <div class="media d-flex align-items-center"><img
                src="https://www.clipartmax.com/png/small/72-722180_these-are-some-cats-avatar-i-drew-during-my-free-time-black.png"
                alt="..." width="65" class="mr-3 rounded-circle img-thumbnail shadow-sm">
            <div class="media-body" style="margin-left: 0.5 em;">
                <h4 class="m-0" id="lblUsername"></h4>
                <p class="font-weight-light text-muted mb-0">Web developer</p>
            </div>
        </div>
    </div>

    <p class="text-gray font-weight-bold text-uppercase px-3 small pb-4 mb-0">Main</p>

    <ul class="nav flex-column bg-white mb-0">
        <li class="nav-item">
            <a href="#" class="nav-link text-dark font-italic bg-light">
                <i class="fa fa-th-large mr-3 text-primary fa-fw"></i>
                Home
            </a>
        </li>
        <li class="nav-item">
            <a href="#" class="nav-link text-dark font-italic">
                <i class="fa fa-address-card mr-3 text-primary fa-fw"></i>
                About
            </a>
        </li>
        <li class="nav-item">
            <a href="#" class="nav-link text-dark font-italic">
                <i class="fa fa-cubes mr-3 text-primary fa-fw"></i>
                Services
            </a>
        </li>
        <li class="nav-item">
            <a href="#" class="nav-link text-dark font-italic">
                <i class="fa fa-picture-o mr-3 text-primary fa-fw"></i>
                Gallery
            </a>
        </li>
    </ul>

    <p class="text-gray font-weight-bold text-uppercase px-3 small py-4 mb-0">Charts</p>

    <ul class="nav flex-column bg-white mb-0">
        <li class="nav-item">
            <a href="#" class="nav-link text-dark font-italic">
                <i class="fa fa-area-chart mr-3 text-primary fa-fw"></i>
                Area charts
            </a>
        </li>
        <li class="nav-item">
            <a href="#" class="nav-link text-dark font-italic">
                <i class="fa fa-bar-chart mr-3 text-primary fa-fw"></i>
                Bar charts
            </a>
        </li>
        <li class="nav-item">
            <a href="#" class="nav-link text-dark font-italic">
                <i class="fa fa-pie-chart mr-3 text-primary fa-fw"></i>
                Pie charts
            </a>
        </li>
        <li class="nav-item">
            <a href="#" class="nav-link text-dark font-italic">
                <i class="fa fa-line-chart mr-3 text-primary fa-fw"></i>
                Line charts
            </a>
        </li>
    </ul>

    <p class="text-gray font-weight-bold text-uppercase px-3 small py-4 mb-0">Session</p>

    <ul class="nav flex-column bg-white mb-0">
        <li class="nav-item">
            <a id="logout" href="javascript:logOut();" class="nav-link text-dark font-italic">
                <i class="fa fa-chain-broken mr-3 text-primary fa-fw"></i>
                Logout
            </a>
        </li>
    </ul>
</div>

<div class="page-content p-5" id="content">
    <!-- Toggle button -->
    <button id="sidebarCollapse" type="button" class="btn btn-light bg-white rounded-pill shadow-sm px-4 mb-4"><i
            class="fa fa-bars mr-2"></i><small class="text-uppercase font-weight-bold">Toggle</small></button>

    <h2 class="display-4 text-white">All project</h2>
    <div class="row">
        <div class="col-md-1">
            <span class="text-white" style="font-size: large;">Project</span>
        </div>
        <div class="col-md-2">
            <select id="projectTab" class="form-select" style="width: fit-content;">
            </select>
        </div>
    </div>
    <br>
    <div class="row">
        <div class="col-md-1">
            <span class="text-white" style="font-size: large;">Version</span>
        </div>
        <div class="col-md-2">
            <select id="versionTab" class="form-select" style="width: fit-content;">
            </select>
        </div>
    </div>
    <div class="separator"></div>
    <div class="row text-white">
        <div class="col">
            <div class="bg-white p-5 rounded shadow-sm">
                <p style="color: black; word-break: break-word;" id="dataUser"></p>
            </div>
        </div>
    </div>

</div>
<script>
    var projectConfig = {};
    $(function () {
        // Check if the cookie exists or cookie already expried
        if (document.cookie.indexOf("username") === -1) {
            window.location.assign('/login');
        }
        // Sidebar toggle behavior
        $('#sidebarCollapse').on('click', function () {
            $('#sidebar, #content').toggleClass('active');
        });
        $('#lblUsername').text(document.cookie.split('; ')[0].split('=')[1]);
        getData().then((data) => {
            console.log(data);
            // getVersion(data).then((data) => {
            //     console.log(data);
            // });
        }).catch((error) => {
            console.error(error);
        });
        console.log(3);




        $('#projectTab').on('change', function () {
            $('#dataUser').text(''); 
            if (this.value === '') return;
            // get data 1
            const db = firebase.app(this.value).database();
            db.goOnline();
            let versionOption = document.getElementById('versionTab');
            $('#versionTab').find('option').remove().end();
            let opt = document.createElement('option');
            opt.value = '';
            opt.innerHTML = '';
            versionOption.appendChild(opt);
            db.ref().get().then((snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    var keystr = childSnapshot.key;
                    //var value = childSnapshot.val();
                    var opt = document.createElement('option');
                    opt.value = keystr;
                    opt.innerHTML = keystr;
                    versionOption.appendChild(opt);
                })
            })

        });

        $('#versionTab').on('change', function () {
            if (this.value === '') {
                $('#dataUser').text('');
                return;
            }
            // get data 1
            let project = $('#projectTab').find(":selected").val();
            const db = firebase.app(project).database();
            db.goOnline();


            db.ref().child(this.value).child("userdata").get().then((snapshot) => {
                if (snapshot.exists()) {
                    $('#dataUser').text(JSON.stringify(snapshot.val()));
                    console.log(snapshot.val());
                } else {
                    console.log("Current have 0 record.");
                }
            }).catch((error) => {
                console.error(error);
            });
        });
    });

    async function getData() {
        let defaultProject = '';
        defaultDb.goOnline();
        const snapshot = await databaseConfig.get();
        let firstKey;
        let select = document.getElementById('projectTab');
        let opt = document.createElement('option');
        opt.value = '';
        opt.innerHTML = '';
        select.appendChild(opt);
        snapshot.forEach((childSnapshot) => {
            if (!firstKey) {
                firstKey = childSnapshot.key;
            }
            var keystr = childSnapshot.key;
            var value = childSnapshot.val();
            projectConfig[keystr] = value;
            firebase.initializeApp(value, keystr);
            console.log('initializeApp: ' + keystr);
            var opt = document.createElement('option');
            opt.value = keystr;
            opt.innerHTML = keystr;
            select.appendChild(opt);
            defaultProject = keystr;
        });
        
        return firstKey;
        // databaseConfig.get().then((snapshot) => {
        //     snapshot.forEach((childSnapshot) => {
        //         var keystr = childSnapshot.key;
        //         var value = childSnapshot.val();
        //         projectConfig[keystr] = value;
        //         firebase.initializeApp(value, keystr);
        //         console.log('initializeApp: ' + keystr);
        //         var opt = document.createElement('option');
        //         opt.value = keystr;
        //         opt.innerHTML = keystr;
        //         select.appendChild(opt);
        //         defaultProject = keystr;
        //     });
        // }).finally(() => {
        //     console.log('Experiment completed');
        //     $("#projectTab").val($("#projectTab option:first").val());
        //     // $('#versionTab').find('option').remove().end();
        //     // let db = firebase.database(firebase.app($('#projectTab').find(":selected").val()));
        //     // let versionOption = document.getElementById('versionTab');
        //     // let opt = document.createElement('option');
        //     // opt.value = '';
        //     // opt.innerHTML = '';
        //     // versionOption.appendChild(opt);
        //     // db.ref().get().then((snapshot) => {
        //     //     snapshot.forEach((childSnapshot) => {
        //     //         var keystr = childSnapshot.key;
        //     //         //var value = childSnapshot.val();
        //     //         var opt = document.createElement('option');
        //     //         opt.value = keystr;
        //     //         opt.innerHTML = keystr;
        //     //         versionOption.appendChild(opt);
        //     //     })
        //     // })

        // });
        // return $("#projectTab option:first").val();
    }

    async function getVersion(project) {
        $('#versionTab').find('option').remove().end();
        let db = firebase.database(firebase.app(project));
        let versionOption = document.getElementById('versionTab');
        let opt = document.createElement('option');
        opt.value = '';
        opt.innerHTML = '';
        versionOption.appendChild(opt);
        const snapshot = await db.ref().get();

        snapshot.forEach((childSnapshot) => {
            var keystr = childSnapshot.key;
            //var value = childSnapshot.val();
            var opt = document.createElement('option');
            opt.value = keystr;
            opt.innerHTML = keystr;
            versionOption.appendChild(opt);
        })
        return 1;
    }





    function logOut() {
        document.cookie.split(";").forEach(function (c) { document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); });
        window.location.assign('/login');
    }
</script>

</html>